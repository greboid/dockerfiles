package:
  name: thelounge
  description: Modern, responsive, and self-hosted web IRC client

stages:
  - name: yarnbase
    environment:
      base-image: node
      workdir: /app
    pipeline:
      - name: Enable corepack
        run: corepack enable

  - name: builder
    environment:
      base-image: node
      args:
        TAG: "{{github_tag \"thelounge/thelounge\"}}"
      environment:
        THELOUNGE_HOME: /var/opt/thelounge
      workdir: /app
      packages:
        - git
        - python3
    pipeline:
      - name: Install thelounge
        run: |
          set -eux;
          git clone --branch v4.4.3 --single-branch https://github.com/thelounge/thelounge.git
          cd thelounge
          yarn install
          NODE_ENV=production yarn build

      - name: Create nonroot home directory
        uses: create-directories
        with:
          directories:
            - path: /home/nonroot
              owner: "65532:65532"

      - name: Create symlink for thelounge command
        run: |
          mkdir -p /usr/local/bin
          ln -s /app/thelounge/index.js /usr/local/bin/thelounge

  - name: rootfs
    environment:
      base-image: node
    pipeline:
      - name: Copy thelounge to rootfs
        copy:
          from-stage: builder
          from: /app/thelounge
          to: /rootfs/app/thelounge
      - name: Copy symlink to rootfs
        copy:
          from-stage: builder
          from: /usr/local/bin/thelounge
          to: /rootfs/usr/local/bin/thelounge
      - name: Copy nonroot home to rootfs
        copy:
          from-stage: builder
          from: /home/nonroot
          to: /rootfs/home/nonroot
  - name: Final
    environment:
      base-image: node
      environment:
        THELOUNGE_HOME: /var/opt/thelounge
      entrypoint:
        - thelounge

    pipeline:
      - name: Copy rootfs to root
        copy:
          from-stage: rootfs
          from: /rootfs/
          to: /
