FROM {{image "rust"}} AS build

WORKDIR /src

# Clone and build static-web-server
# Clone repository
RUN git clone --depth=1 --branch {{github_tag "static-web-server/static-web-server"}} "https://github.com/static-web-server/static-web-server" /src/static-web-server/static-web-server
# Apply patch keepqueriesonrewrites.diff
COPY keepqueriesonrewrites.diff /src/static-web-server/static-web-server/
RUN cd /src/static-web-server/static-web-server && patch -p1 < keepqueriesonrewrites.diff
# Build binary
RUN cd /src/static-web-server/static-web-server && cargo build --release --target x86_64-unknown-linux-musl
# Copy binary to final location
RUN find /src/static-web-server/static-web-server/target/x86_64-unknown-linux-musl/release -maxdepth 1 -type f -executable -exec cp {} /main \;


FROM {{image "base"}} AS rootfs

# Copy binary to rootfs
COPY --from=build /main /rootfs/sws


FROM {{image "base"}}

# Copy rootfs to root
COPY --from=rootfs /rootfs/ /

ENTRYPOINT ["/sws"]


