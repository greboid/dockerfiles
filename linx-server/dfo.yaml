package:
  name: linx-server
  description: Self-hosted file/code/media sharing website

stages:
  - name: build
    environment:
      base-image: golang
      packages:
        - git
    pipeline:
      - name: Clone and build
        uses: clone-and-build-go
        with:
          repo: https://github.com/csmith/linx-server
      - name: Make volumes
        uses: create-directories
        with:
          directories:
            - path: /data/files
              owner: "65532:65532"
            - path: /data/meta
              owner: "65532:65532"
  - name: rootfs
    environment:
      base-image: base
    pipeline:
      - name: Copy binary and data to rootfs
        copy:
          from-stage: build
          from: /main
          to: /rootfs/linx-server
      - copy:
          from-stage: build
          from: /data
          to: /rootfs/data
      - copy:
          from-stage: build
          from: /notices
          to: /rootfs/notices
  - name: Final
    environment:
      base-image: base
      expose:
        - "8080"
      volume:
        - /data/files
        - /data/meta
      entrypoint:
        - /linx-server
        - -bind=0.0.0.0:8080
        - -filespath=/data/files/
        - -metapath=/data/meta/
      cmd:
        - -sitename=linx
        - -allowhotlink
    pipeline:
      - name: Copy rootfs to root
        copy:
          from-stage: rootfs
          from: /rootfs/
          to: /
