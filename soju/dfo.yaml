package:
  name: soju
  description: IRC bouncer

stages:
  - name: build
    environment:
      base-image: golang
      packages:
        - git
    pipeline:
      - name: Clone and build
        uses: clone-and-build-go
        with:
          repo: https://github.com/emersion/soju
          package: ./cmd/soju
          output: /soju
      - name: Clone and build
        uses: clone-and-build-go
        with:
          repo: https://github.com/emersion/soju
          package: ./cmd/sojuctl
          output: /sojuctl
      - name: Clone and build
        uses: clone-and-build-go
        with:
          repo: https://github.com/emersion/soju
          package: ./cmd/sojudb
          output: /sojudb
      - name: Create volume
        uses: create-directories
        with:
          directories:
            - path: /data
  - name: rootfs
    environment:
      base-image: base
    pipeline:
      - name: Copy soju binaries to rootfs
        copy:
          from-stage: build
          from: /soju
          to: /rootfs/soju
      - copy:
          from-stage: build
          from: /sojuctl
          to: /rootfs/sojuctl
      - copy:
          from-stage: build
          from: /sojudb
          to: /rootfs/sojudb
      - copy:
          from-stage: build
          from: /data
          to: /rootfs/data
      - copy:
          from-stage: build
          from: /notices
          to: /rootfs/notices
  - name: Final
    environment:
      base-image: base
      entrypoint:
        - /soju
    pipeline:
      - name: Copy rootfs to root
        copy:
          from-stage: rootfs
          from: /rootfs/
          to: /
