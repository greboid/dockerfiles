  on:
    workflow_call:
      inputs:
        PROJECT_NAME:
          required: true
          type: string
  name: Build Containers
  jobs:
    build:
      name: Build
      runs-on: ubuntu-latest
      steps:
        - name: Checkout source
          uses: actions/checkout@master
        - name: Setup Go
          uses: actions/setup-go@v5
          with:
            go-version: 'stable'
            cache: false
        - name: Install latest tool
          uses: mattdowdell/go-installer@v0.3.0
          with:
            package: github.com/csmith/contempt/cmd/contempt
        - name: Login to private registry
          uses: redhat-actions/podman-login@v1
          with:
            username: ${{ secrets.REGISTRY_USER }}
            password: ${{ secrets.REGISTRY_PASSWORD }}
            registry: ${{ secrets.REGISTRY }}
        - name: Configure Git
          uses: snow-actions/git-config-user@v1.0.0
          with:
            name: ${{ secrets.GIT_USERNAME }}
            email: ${{ secrets.GIT_EMAIL }}
        - name: Update
          env:
            BUILDAH_ISOLATION: chroot
            REGISTRY: ${{ secrets.REGISTRY }}
            SOURCE_LINK: https://github.com/greboid/dockerfiles/blob/master/
          run: contempt -template Containerfile.gotpl -output Containerfile --commit --build --push --project ${{ inputs.PROJECT_NAME }} . .
        - name: Check mirror
          uses: andstor/file-existence-action@v3
          id: check_mirror
          with:
            files: "${{ inputs.PROJECT_NAME }}/MIRROR"
        - name: Check if image was built
          if: steps.check_mirror.outputs.files_exists == 'true'
          continue-on-error: true
          id: check_mirror_exists
          run: buildah images ${{ secrets.REGISTRY }}/${{ inputs.PROJECT_NAME }} > /dev/null 2>&1 && echo "status=success" >> "$GITHUB_OUTPUT"; true
        - name: Login to mirror target registry
          if: steps.check_mirror_exists.outputs.status == 'success'
          run: /usr/bin/podman login -u "${{ github.repository_owner }}" -p "${{ secrets.CONTEMPT_TOKEN }}" ghcr.io --verbose
        - name: Retag image to mirror
          if: steps.check_mirror_exists.outputs.status == 'success'
          run: buildah tag ${{ secrets.REGISTRY }}/${{ inputs.PROJECT_NAME }} ghcr.io/${{ github.repository }}/${{ inputs.PROJECT_NAME }}
        - name: Mirror the image
          if: steps.check_mirror_exists.outputs.status == 'success'
          run: buildah push ghcr.io/${{ github.repository }}/${{ inputs.PROJECT_NAME }}
        - name: Push changes
          uses: cutlerydrawer/action-git-try-push@v2
          with:
            tries: 5
