  on:
    workflow_call:
      inputs:
        PROJECT_NAME:
          required: true
          type: string
  name: Build Containers
  jobs:
    build:
      name: Build
      runs-on: ubuntu-latest
      steps:
        - name: Checkout source
          uses: actions/checkout@master
        - name: Install bubblewrap and configure AppArmor
          run: |
            sudo apt-get update && sudo apt-get install -y bubblewrap
            echo "kernel.apparmor_restrict_unprivileged_userns = 0" | sudo tee /etc/sysctl.d/60-apparmor-namespace.conf
            sudo sysctl --system
        - name: Setup Go
          uses: actions/setup-go@v6
          with:
            go-version: 'stable'
            cache: true
        - name: Restore build cache
          id: cache-build
          uses: actions/cache/restore@v4
          with:
            path: |
              ~/go/bin/melange
              ~/go/bin/apko
              dockerfiles
              greboid-dockerfiles.rsa
              greboid-dockerfiles.rsa.pub
              repo/
            key: build-cache-${{ github.run_id }}-${{ github.run_attempt }}
        - name: Install melange
          if: steps.cache-build.outputs.cache-hit != 'true'
          uses: mattdowdell/go-installer@v0.3.0
          with:
            package: chainguard.dev/melange
        - name: Install apko
          if: steps.cache-build.outputs.cache-hit != 'true'
          uses: mattdowdell/go-installer@v0.3.0
          with:
            package: chainguard.dev/apko
        - name: Build tool
          if: steps.cache-build.outputs.cache-hit != 'true'
          run: go build -o dockerfiles .
        - name: Write signing keys to disk
          if: steps.cache-build.outputs.cache-hit != 'true'
          run: |
            echo "${{ secrets.MELANGE_SIGNING_KEY }}" > greboid-dockerfiles.rsa
            chmod 600 greboid-dockerfiles.rsa
            openssl rsa -in greboid-dockerfiles.rsa -pubout -out greboid-dockerfiles.rsa.pub
            chmod 644 greboid-dockerfiles.rsa.pub
        - name: Ensure tools are executable
          if: steps.cache-build.outputs.cache-hit == 'true'
          run: |
            chmod +x ~/go/bin/melange
            chmod +x ~/go/bin/apko
            chmod +x dockerfiles
            chmod 600 greboid-dockerfiles.rsa
            chmod 644 greboid-dockerfiles.rsa.pub
        - name: Login to private registry
          uses: redhat-actions/podman-login@v1
          with:
            username: ${{ secrets.REGISTRY_USER }}
            password: ${{ secrets.REGISTRY_PASS }}
            registry: ${{ secrets.REGISTRY }}
        - name: Configure Git
          uses: snow-actions/git-config-user@v1.0.0
          with:
            name: ${{ secrets.GIT_USERNAME }}
            email: ${{ secrets.GIT_EMAIL }}
        - name: Build and push container
          run: |
            ./dockerfiles ci --registry ${{ secrets.REGISTRY }} --update --push --container ${{ inputs.PROJECT_NAME }}
        - name: Commit changes
          uses: stefanzweifel/git-auto-commit-action@v6
          with:
            commit_message: "Update ${{ inputs.PROJECT_NAME }}"
            file_pattern: 'containers/*'
        - name: Push changes
          uses: cutlerydrawer/action-git-try-push@v2
