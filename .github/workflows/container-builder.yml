  on:
    workflow_call:
      inputs:
        PROJECT_NAME:
          required: true
          type: string
  name: Build Containers
  jobs:
    build:
      name: Build
      runs-on: ubuntu-latest
      steps:
        - name: Checkout source
          uses: actions/checkout@master
        - name: Install bubblewrap
          run: sudo apt-get update && sudo apt-get install -y bubblewrap
        - name: Setup Go
          uses: actions/setup-go@v6
          with:
            go-version: 'stable'
            cache: true
        - name: Install melange
          uses: mattdowdell/go-installer@v0.3.0
          with:
            package: chainguard.dev/melange
        - name: Install apko
          uses: mattdowdell/go-installer@v0.3.0
          with:
            package: chainguard.dev/apko
        - name: Build tool
          run: go build -o dockerfiles .
        - name: Login to private registry
          uses: redhat-actions/podman-login@v1
          with:
            username: ${{ secrets.REGISTRY_USER }}
            password: ${{ secrets.REGISTRY_PASS }}
            registry: ${{ secrets.REGISTRY }}
        - name: Configure Git
          uses: snow-actions/git-config-user@v1.0.0
          with:
            name: ${{ secrets.GIT_USERNAME }}
            email: ${{ secrets.GIT_EMAIL }}
        - name: Write signing keys to disk
          run: |
            echo "${{ secrets.MELANGE_SIGNING_KEY }}" > greboid-dockerfiles.rsa
            chmod 600 greboid-dockerfiles.rsa
            openssl rsa -in greboid-dockerfiles.rsa -pubout -out greboid-dockerfiles.rsa.pub
            chmod 644 greboid-dockerfiles.rsa.pub
        - name: Build and push container
          run: |
            ./dockerfiles ci --registry ${{ secrets.REGISTRY }} --update --push --container ${{ inputs.PROJECT_NAME }}
        - name: Commit changes
          uses: stefanzweifel/git-auto-commit-action@v6
          with:
            commit_message: "Update ${{ inputs.PROJECT_NAME }}"
            file_pattern: 'containers/*'
        - name: Push changes
          uses: cutlerydrawer/action-git-try-push@v2
