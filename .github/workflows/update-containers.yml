name: Update Containers
"on":
    workflow_dispatch: {}
    workflow_run:
        workflows:
            - Update Workflow
        types:
            - completed
concurrency: dockerfiles
permissions:
    contents: write
jobs:
    alpine:
        name: Build alpine
        needs:
            - setup-cache
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: alpine
    base:
        name: Build base
        needs:
            - setup-cache
            - baseroot
            - update-layer-1
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: base
    baseroot:
        name: Build baseroot
        needs:
            - setup-cache
            - alpine
            - update-layer-0
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: baseroot
    centauri:
        name: Build centauri
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: centauri
    commit-changes:
        name: Commit updated files
        runs-on: ubuntu-latest
        needs:
            - update-layer-4
        steps:
            - name: Checkout code
              uses: actions/checkout@v6
              with:
                token: ${{ secrets.GITHUB_TOKEN }}
            - name: Setup Go
              uses: actions/setup-go@v6
              with:
                cache: "false"
                go-version: stable
            - name: Install latest dfo
              uses: mattdowdell/go-installer@v0.3.0
              with:
                package: github.com/greboid/dfo
            - name: Update all Containerfiles with built image digests
              run: |
                set -e
                echo 'Updating all Containerfiles with built image digests...'
                dfo single --registry "${{ secrets.REGISTRY }}" alpine
                dfo single --registry "${{ secrets.REGISTRY }}" baseroot
                dfo single --registry "${{ secrets.REGISTRY }}" golang
                dfo single --registry "${{ secrets.REGISTRY }}" node
                dfo single --registry "${{ secrets.REGISTRY }}" rust
                dfo single --registry "${{ secrets.REGISTRY }}" texlive
                dfo single --registry "${{ secrets.REGISTRY }}" base
                dfo single --registry "${{ secrets.REGISTRY }}" immich
                dfo single --registry "${{ secrets.REGISTRY }}" centauri
                dfo single --registry "${{ secrets.REGISTRY }}" dockercleanup
                dfo single --registry "${{ secrets.REGISTRY }}" dotege
                dfo single --registry "${{ secrets.REGISTRY }}" dsp
                dfo single --registry "${{ secrets.REGISTRY }}" ergo
                dfo single --registry "${{ secrets.REGISTRY }}" githubmirror
                dfo single --registry "${{ secrets.REGISTRY }}" golink
                dfo single --registry "${{ secrets.REGISTRY }}" goplum
                dfo single --registry "${{ secrets.REGISTRY }}" httpredirect
                dfo single --registry "${{ secrets.REGISTRY }}" identd
                dfo single --registry "${{ secrets.REGISTRY }}" irc-bot
                dfo single --registry "${{ secrets.REGISTRY }}" irc-distribution
                dfo single --registry "${{ secrets.REGISTRY }}" irc-github
                dfo single --registry "${{ secrets.REGISTRY }}" irc-goplum
                dfo single --registry "${{ secrets.REGISTRY }}" irc-notifier
                dfo single --registry "${{ secrets.REGISTRY }}" irc-webhook
                dfo single --registry "${{ secrets.REGISTRY }}" linx-server
                dfo single --registry "${{ secrets.REGISTRY }}" miniflux
                dfo single --registry "${{ secrets.REGISTRY }}" postgres-15
                dfo single --registry "${{ secrets.REGISTRY }}" puzzles
                dfo single --registry "${{ secrets.REGISTRY }}" redis
                dfo single --registry "${{ secrets.REGISTRY }}" registryauth
                dfo single --registry "${{ secrets.REGISTRY }}" soju
                dfo single --registry "${{ secrets.REGISTRY }}" sws
                dfo single --registry "${{ secrets.REGISTRY }}" thelounge
                dfo single --registry "${{ secrets.REGISTRY }}" tsp
                dfo single --registry "${{ secrets.REGISTRY }}" vaultwarden
                dfo single --registry "${{ secrets.REGISTRY }}" watchtower
                dfo single --registry "${{ secrets.REGISTRY }}" webhooked
                dfo single --registry "${{ secrets.REGISTRY }}" gamja
            - name: Commit and push changes
              run: |-
                git config user.name "github-actions[bot]"
                git config user.email "github-actions[bot]@users.noreply.github.com"
                git add .
                if git diff --staged --quiet; then
                  echo "No changes to commit"
                else
                  git commit -m "Update Containerfiles and BOMs with built image digests"
                  git pull --rebase origin $(git branch --show-current)
                  git push
                fi
    dockercleanup:
        name: Build dockercleanup
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: dockercleanup
    dotege:
        name: Build dotege
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: dotege
    dsp:
        name: Build dsp
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: dsp
    ergo:
        name: Build ergo
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: ergo
    gamja:
        name: Build gamja
        needs:
            - setup-cache
            - alpine
            - base
            - node
            - sws
            - update-layer-3
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: gamja
    githubmirror:
        name: Build githubmirror
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: githubmirror
    golang:
        name: Build golang
        needs:
            - setup-cache
            - alpine
            - update-layer-0
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: golang
    golink:
        name: Build golink
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: golink
    goplum:
        name: Build goplum
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: goplum
    httpredirect:
        name: Build httpredirect
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: httpredirect
    identd:
        name: Build identd
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: identd
    immich:
        name: Build immich
        needs:
            - setup-cache
            - alpine
            - node
            - update-layer-1
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: immich
    irc-bot:
        name: Build irc-bot
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: irc-bot
    irc-distribution:
        name: Build irc-distribution
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: irc-distribution
    irc-github:
        name: Build irc-github
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: irc-github
    irc-goplum:
        name: Build irc-goplum
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: irc-goplum
    irc-notifier:
        name: Build irc-notifier
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: irc-notifier
    irc-webhook:
        name: Build irc-webhook
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: irc-webhook
    linx-server:
        name: Build linx-server
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: linx-server
    miniflux:
        name: Build miniflux
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: miniflux
    node:
        name: Build node
        needs:
            - setup-cache
            - alpine
            - update-layer-0
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: node
    postgres-15:
        name: Build postgres-15
        needs:
            - setup-cache
            - alpine
            - base
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: postgres-15
    puzzles:
        name: Build puzzles
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: puzzles
    redis:
        name: Build redis
        needs:
            - setup-cache
            - alpine
            - base
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: redis
    registryauth:
        name: Build registryauth
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: registryauth
    rust:
        name: Build rust
        needs:
            - setup-cache
            - alpine
            - update-layer-0
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: rust
    setup-cache:
        name: Setup cache
        runs-on: ubuntu-latest
        steps:
            - name: Setup Go
              uses: actions/setup-go@v6
              with:
                cache: "false"
                go-version: stable
            - name: Install latest dfo
              uses: mattdowdell/go-installer@v0.3.0
              with:
                package: github.com/greboid/dfo
    soju:
        name: Build soju
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: soju
    sws:
        name: Build sws
        needs:
            - setup-cache
            - base
            - rust
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: sws
    texlive:
        name: Build texlive
        needs:
            - setup-cache
            - alpine
            - update-layer-0
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: texlive
    thelounge:
        name: Build thelounge
        needs:
            - setup-cache
            - base
            - node
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: thelounge
    tsp:
        name: Build tsp
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: tsp
    update-layer-0:
        name: Update layer 0 tags
        runs-on: ubuntu-latest
        needs:
            - setup-cache
            - alpine
        steps:
            - name: Checkout code
              uses: actions/checkout@v6
              with:
                token: ${{ secrets.GITHUB_TOKEN }}
            - name: Setup Go
              uses: actions/setup-go@v6
              with:
                cache: "false"
                go-version: stable
            - name: Install latest dfo
              uses: mattdowdell/go-installer@v0.3.0
              with:
                package: github.com/greboid/dfo
            - name: Update layer 0 Containerfiles
              run: |
                set -e
                echo 'Updating alpine...'
                dfo single --registry "${{ secrets.REGISTRY }}" alpine
    update-layer-1:
        name: Update layer 1 tags
        runs-on: ubuntu-latest
        needs:
            - setup-cache
            - baseroot
            - golang
            - node
            - rust
            - texlive
        steps:
            - name: Checkout code
              uses: actions/checkout@v6
              with:
                token: ${{ secrets.GITHUB_TOKEN }}
            - name: Setup Go
              uses: actions/setup-go@v6
              with:
                cache: "false"
                go-version: stable
            - name: Install latest dfo
              uses: mattdowdell/go-installer@v0.3.0
              with:
                package: github.com/greboid/dfo
            - name: Update layer 1 Containerfiles
              run: |
                set -e
                echo 'Updating baseroot...'
                dfo single --registry "${{ secrets.REGISTRY }}" baseroot
                echo 'Updating golang...'
                dfo single --registry "${{ secrets.REGISTRY }}" golang
                echo 'Updating node...'
                dfo single --registry "${{ secrets.REGISTRY }}" node
                echo 'Updating rust...'
                dfo single --registry "${{ secrets.REGISTRY }}" rust
                echo 'Updating texlive...'
                dfo single --registry "${{ secrets.REGISTRY }}" texlive
    update-layer-2:
        name: Update layer 2 tags
        runs-on: ubuntu-latest
        needs:
            - setup-cache
            - base
            - immich
        steps:
            - name: Checkout code
              uses: actions/checkout@v6
              with:
                token: ${{ secrets.GITHUB_TOKEN }}
            - name: Setup Go
              uses: actions/setup-go@v6
              with:
                cache: "false"
                go-version: stable
            - name: Install latest dfo
              uses: mattdowdell/go-installer@v0.3.0
              with:
                package: github.com/greboid/dfo
            - name: Update layer 2 Containerfiles
              run: |
                set -e
                echo 'Updating base...'
                dfo single --registry "${{ secrets.REGISTRY }}" base
                echo 'Updating immich...'
                dfo single --registry "${{ secrets.REGISTRY }}" immich
    update-layer-3:
        name: Update layer 3 tags
        runs-on: ubuntu-latest
        needs:
            - setup-cache
            - centauri
            - dockercleanup
            - dotege
            - dsp
            - ergo
            - githubmirror
            - golink
            - goplum
            - httpredirect
            - identd
            - irc-bot
            - irc-distribution
            - irc-github
            - irc-goplum
            - irc-notifier
            - irc-webhook
            - linx-server
            - miniflux
            - postgres-15
            - puzzles
            - redis
            - registryauth
            - soju
            - sws
            - thelounge
            - tsp
            - vaultwarden
            - watchtower
            - webhooked
        steps:
            - name: Checkout code
              uses: actions/checkout@v6
              with:
                token: ${{ secrets.GITHUB_TOKEN }}
            - name: Setup Go
              uses: actions/setup-go@v6
              with:
                cache: "false"
                go-version: stable
            - name: Install latest dfo
              uses: mattdowdell/go-installer@v0.3.0
              with:
                package: github.com/greboid/dfo
            - name: Update layer 3 Containerfiles
              run: |
                set -e
                echo 'Updating centauri...'
                dfo single --registry "${{ secrets.REGISTRY }}" centauri
                echo 'Updating dockercleanup...'
                dfo single --registry "${{ secrets.REGISTRY }}" dockercleanup
                echo 'Updating dotege...'
                dfo single --registry "${{ secrets.REGISTRY }}" dotege
                echo 'Updating dsp...'
                dfo single --registry "${{ secrets.REGISTRY }}" dsp
                echo 'Updating ergo...'
                dfo single --registry "${{ secrets.REGISTRY }}" ergo
                echo 'Updating githubmirror...'
                dfo single --registry "${{ secrets.REGISTRY }}" githubmirror
                echo 'Updating golink...'
                dfo single --registry "${{ secrets.REGISTRY }}" golink
                echo 'Updating goplum...'
                dfo single --registry "${{ secrets.REGISTRY }}" goplum
                echo 'Updating httpredirect...'
                dfo single --registry "${{ secrets.REGISTRY }}" httpredirect
                echo 'Updating identd...'
                dfo single --registry "${{ secrets.REGISTRY }}" identd
                echo 'Updating irc-bot...'
                dfo single --registry "${{ secrets.REGISTRY }}" irc-bot
                echo 'Updating irc-distribution...'
                dfo single --registry "${{ secrets.REGISTRY }}" irc-distribution
                echo 'Updating irc-github...'
                dfo single --registry "${{ secrets.REGISTRY }}" irc-github
                echo 'Updating irc-goplum...'
                dfo single --registry "${{ secrets.REGISTRY }}" irc-goplum
                echo 'Updating irc-notifier...'
                dfo single --registry "${{ secrets.REGISTRY }}" irc-notifier
                echo 'Updating irc-webhook...'
                dfo single --registry "${{ secrets.REGISTRY }}" irc-webhook
                echo 'Updating linx-server...'
                dfo single --registry "${{ secrets.REGISTRY }}" linx-server
                echo 'Updating miniflux...'
                dfo single --registry "${{ secrets.REGISTRY }}" miniflux
                echo 'Updating postgres-15...'
                dfo single --registry "${{ secrets.REGISTRY }}" postgres-15
                echo 'Updating puzzles...'
                dfo single --registry "${{ secrets.REGISTRY }}" puzzles
                echo 'Updating redis...'
                dfo single --registry "${{ secrets.REGISTRY }}" redis
                echo 'Updating registryauth...'
                dfo single --registry "${{ secrets.REGISTRY }}" registryauth
                echo 'Updating soju...'
                dfo single --registry "${{ secrets.REGISTRY }}" soju
                echo 'Updating sws...'
                dfo single --registry "${{ secrets.REGISTRY }}" sws
                echo 'Updating thelounge...'
                dfo single --registry "${{ secrets.REGISTRY }}" thelounge
                echo 'Updating tsp...'
                dfo single --registry "${{ secrets.REGISTRY }}" tsp
                echo 'Updating vaultwarden...'
                dfo single --registry "${{ secrets.REGISTRY }}" vaultwarden
                echo 'Updating watchtower...'
                dfo single --registry "${{ secrets.REGISTRY }}" watchtower
                echo 'Updating webhooked...'
                dfo single --registry "${{ secrets.REGISTRY }}" webhooked
    update-layer-4:
        name: Update layer 4 tags
        runs-on: ubuntu-latest
        needs:
            - setup-cache
            - gamja
        steps:
            - name: Checkout code
              uses: actions/checkout@v6
              with:
                token: ${{ secrets.GITHUB_TOKEN }}
            - name: Setup Go
              uses: actions/setup-go@v6
              with:
                cache: "false"
                go-version: stable
            - name: Install latest dfo
              uses: mattdowdell/go-installer@v0.3.0
              with:
                package: github.com/greboid/dfo
            - name: Update layer 4 Containerfiles
              run: |
                set -e
                echo 'Updating gamja...'
                dfo single --registry "${{ secrets.REGISTRY }}" gamja
    vaultwarden:
        name: Build vaultwarden
        needs:
            - setup-cache
            - base
            - rust
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: vaultwarden
    watchtower:
        name: Build watchtower
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: watchtower
    webhooked:
        name: Build webhooked
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: webhooked
