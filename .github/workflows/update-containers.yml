on:
  workflow_dispatch:
  schedule:
    - cron: '42 12 * * *'
  push:
    paths-ignore:
      - '*.go'
      - '.github/**'
      - 'README.md'
name: Update Containers
concurrency: dockerfiles
permissions:
  contents: write
jobs:
  setup-cache:
    name: Setup cache
    runs-on: ubuntu-latest
    steps:
        - name: Checkout
          uses: actions/checkout@master
        - name: Install bubblewrap and configure AppArmor
          run: |
            sudo apt-get update && sudo apt-get install -y bubblewrap
            echo "kernel.apparmor_restrict_unprivileged_userns = 0" | sudo tee /etc/sysctl.d/60-apparmor-namespace.conf
            sudo sysctl --system
        - name: Setup Go
          uses: actions/setup-go@v6
          with:
            go-version: 'stable'
            cache: true
        - name: Install melange
          uses: mattdowdell/go-installer@v0.3.0
          with:
            package: chainguard.dev/melange
        - name: Install apko
          uses: mattdowdell/go-installer@v0.3.0
          with:
            package: chainguard.dev/apko
        - name: Build tool
          run: go build -o dockerfiles .
        - name: Generate signing keys
          run: |
            echo "${{ secrets.MELANGE_SIGNING_KEY }}" > greboid-dockerfiles.rsa
            chmod 600 greboid-dockerfiles.rsa
            openssl rsa -in greboid-dockerfiles.rsa -pubout -out greboid-dockerfiles.rsa.pub
            chmod 644 greboid-dockerfiles.rsa.pub
        - name: Build required packages
          run: |
            mkdir -p repo
            # Get list of packages required by containers affected by package updates
            REQUIRED_PACKAGES=$(./dockerfiles list-required-packages)
            if [ -z "$REQUIRED_PACKAGES" ]; then
              echo "No package updates found - no packages to build"
            else
              echo "Required packages for containers with package updates:"
              echo "$REQUIRED_PACKAGES"
              echo ""
              # Build each required package
              for package in $REQUIRED_PACKAGES; do
                echo "Building $package..."
                ~/go/bin/melange build "packages/${package}.yaml" \
                  --arch x86_64 \
                  --signing-key greboid-dockerfiles.rsa \
                  --out-dir repo/ \
                  --cache-dir /tmp/melange-cache || echo "Failed to build $package"
              done
            fi
        - name: Cache build tools and packages
          uses: actions/cache@v4
          with:
            path: |
              ~/go/bin/melange
              ~/go/bin/apko
              dockerfiles
              greboid-dockerfiles.rsa
              greboid-dockerfiles.rsa.pub
              repo/
            key: build-cache-${{ github.run_id }}-${{ github.run_attempt }}
  centauri:
    name: Build centauri
    needs:
        - setup-cache
    uses: ./.github/workflows/container-builder.yml
    secrets: inherit
    with:
        PROJECT_NAME: centauri
        CACHE_KEY: build-cache-${{ github.run_id }}-${{ github.run_attempt }}
  dockercleanup:
    name: Build dockercleanup
    needs:
        - setup-cache
    uses: ./.github/workflows/container-builder.yml
    secrets: inherit
    with:
        PROJECT_NAME: dockercleanup
        CACHE_KEY: build-cache-${{ github.run_id }}-${{ github.run_attempt }}
  dotege:
    name: Build dotege
    needs:
        - setup-cache
    uses: ./.github/workflows/container-builder.yml
    secrets: inherit
    with:
        PROJECT_NAME: dotege
        CACHE_KEY: build-cache-${{ github.run_id }}-${{ github.run_attempt }}
  dsp:
    name: Build dsp
    needs:
        - setup-cache
    uses: ./.github/workflows/container-builder.yml
    secrets: inherit
    with:
        PROJECT_NAME: dsp
        CACHE_KEY: build-cache-${{ github.run_id }}-${{ github.run_attempt }}
  ergo:
    name: Build ergo
    needs:
        - setup-cache
    uses: ./.github/workflows/container-builder.yml
    secrets: inherit
    with:
        PROJECT_NAME: ergo
        CACHE_KEY: build-cache-${{ github.run_id }}-${{ github.run_attempt }}
  githubmirror:
    name: Build githubmirror
    needs:
        - setup-cache
    uses: ./.github/workflows/container-builder.yml
    secrets: inherit
    with:
        PROJECT_NAME: githubmirror
        CACHE_KEY: build-cache-${{ github.run_id }}-${{ github.run_attempt }}
  golink:
    name: Build golink
    needs:
        - setup-cache
    uses: ./.github/workflows/container-builder.yml
    secrets: inherit
    with:
        PROJECT_NAME: golink
        CACHE_KEY: build-cache-${{ github.run_id }}-${{ github.run_attempt }}
  goplum:
    name: Build goplum
    needs:
        - setup-cache
    uses: ./.github/workflows/container-builder.yml
    secrets: inherit
    with:
        PROJECT_NAME: goplum
        CACHE_KEY: build-cache-${{ github.run_id }}-${{ github.run_attempt }}
  httpredirect:
    name: Build httpredirect
    needs:
        - setup-cache
    uses: ./.github/workflows/container-builder.yml
    secrets: inherit
    with:
        PROJECT_NAME: httpredirect
        CACHE_KEY: build-cache-${{ github.run_id }}-${{ github.run_attempt }}
  identd:
    name: Build identd
    needs:
        - setup-cache
    uses: ./.github/workflows/container-builder.yml
    secrets: inherit
    with:
        PROJECT_NAME: identd
        CACHE_KEY: build-cache-${{ github.run_id }}-${{ github.run_attempt }}
  irc-bot:
    name: Build irc-bot
    needs:
        - setup-cache
    uses: ./.github/workflows/container-builder.yml
    secrets: inherit
    with:
        PROJECT_NAME: irc-bot
        CACHE_KEY: build-cache-${{ github.run_id }}-${{ github.run_attempt }}
  irc-distribution:
    name: Build irc-distribution
    needs:
        - setup-cache
    uses: ./.github/workflows/container-builder.yml
    secrets: inherit
    with:
        PROJECT_NAME: irc-distribution
        CACHE_KEY: build-cache-${{ github.run_id }}-${{ github.run_attempt }}
  irc-github:
    name: Build irc-github
    needs:
        - setup-cache
    uses: ./.github/workflows/container-builder.yml
    secrets: inherit
    with:
        PROJECT_NAME: irc-github
        CACHE_KEY: build-cache-${{ github.run_id }}-${{ github.run_attempt }}
  irc-goplum:
    name: Build irc-goplum
    needs:
        - setup-cache
    uses: ./.github/workflows/container-builder.yml
    secrets: inherit
    with:
        PROJECT_NAME: irc-goplum
        CACHE_KEY: build-cache-${{ github.run_id }}-${{ github.run_attempt }}
  irc-notifier:
    name: Build irc-notifier
    needs:
        - setup-cache
    uses: ./.github/workflows/container-builder.yml
    secrets: inherit
    with:
        PROJECT_NAME: irc-notifier
        CACHE_KEY: build-cache-${{ github.run_id }}-${{ github.run_attempt }}
  irc-webhook:
    name: Build irc-webhook
    needs:
        - setup-cache
    uses: ./.github/workflows/container-builder.yml
    secrets: inherit
    with:
        PROJECT_NAME: irc-webhook
        CACHE_KEY: build-cache-${{ github.run_id }}-${{ github.run_attempt }}
  linx-server:
    name: Build linx-server
    needs:
        - setup-cache
    uses: ./.github/workflows/container-builder.yml
    secrets: inherit
    with:
        PROJECT_NAME: linx-server
        CACHE_KEY: build-cache-${{ github.run_id }}-${{ github.run_attempt }}
  miniflux:
    name: Build miniflux
    needs:
        - setup-cache
    uses: ./.github/workflows/container-builder.yml
    secrets: inherit
    with:
        PROJECT_NAME: miniflux
        CACHE_KEY: build-cache-${{ github.run_id }}-${{ github.run_attempt }}
  postgres-15:
    name: Build postgres-15
    needs:
        - setup-cache
    uses: ./.github/workflows/container-builder.yml
    secrets: inherit
    with:
        PROJECT_NAME: postgres-15
        CACHE_KEY: build-cache-${{ github.run_id }}-${{ github.run_attempt }}
  puzzles:
    name: Build puzzles
    needs:
        - setup-cache
    uses: ./.github/workflows/container-builder.yml
    secrets: inherit
    with:
        PROJECT_NAME: puzzles
        CACHE_KEY: build-cache-${{ github.run_id }}-${{ github.run_attempt }}
  redis:
    name: Build redis
    needs:
        - setup-cache
    uses: ./.github/workflows/container-builder.yml
    secrets: inherit
    with:
        PROJECT_NAME: redis
        CACHE_KEY: build-cache-${{ github.run_id }}-${{ github.run_attempt }}
  registryauth:
    name: Build registryauth
    needs:
        - setup-cache
    uses: ./.github/workflows/container-builder.yml
    secrets: inherit
    with:
        PROJECT_NAME: registryauth
        CACHE_KEY: build-cache-${{ github.run_id }}-${{ github.run_attempt }}
  soju:
    name: Build soju
    needs:
        - setup-cache
    uses: ./.github/workflows/container-builder.yml
    secrets: inherit
    with:
        PROJECT_NAME: soju
        CACHE_KEY: build-cache-${{ github.run_id }}-${{ github.run_attempt }}
  static-web-server:
    name: Build static-web-server
    needs:
        - setup-cache
    uses: ./.github/workflows/container-builder.yml
    secrets: inherit
    with:
        PROJECT_NAME: static-web-server
        CACHE_KEY: build-cache-${{ github.run_id }}-${{ github.run_attempt }}
  thelounge:
    name: Build thelounge
    needs:
        - setup-cache
    uses: ./.github/workflows/container-builder.yml
    secrets: inherit
    with:
        PROJECT_NAME: thelounge
        CACHE_KEY: build-cache-${{ github.run_id }}-${{ github.run_attempt }}
  tsp:
    name: Build tsp
    needs:
        - setup-cache
    uses: ./.github/workflows/container-builder.yml
    secrets: inherit
    with:
        PROJECT_NAME: tsp
        CACHE_KEY: build-cache-${{ github.run_id }}-${{ github.run_attempt }}
  webhooked:
    name: Build webhooked
    needs:
        - setup-cache
    uses: ./.github/workflows/container-builder.yml
    secrets: inherit
    with:
        PROJECT_NAME: webhooked
        CACHE_KEY: build-cache-${{ github.run_id }}-${{ github.run_attempt }}
