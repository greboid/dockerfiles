on:
  workflow_dispatch:
  schedule:
    - cron: '42 12 * * *'
  push:
    paths-ignore:
      - '*.go'
      - '.github/**'
      - 'README.md'
name: Update Containers
concurrency: dockerfiles
permissions:
  contents: write
jobs:
  build:
    name: Build and push containers
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@master
      - name: Install bubblewrap and configure AppArmor
        run: |
          sudo apt-get update && sudo apt-get install -y bubblewrap
          echo "kernel.apparmor_restrict_unprivileged_userns = 0" | sudo tee /etc/sysctl.d/60-apparmor-namespace.conf
          sudo sysctl --system
      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: 'stable'
          cache: true
      - name: Install melange
        uses: mattdowdell/go-installer@v0.3.0
        with:
          package: chainguard.dev/melange
      - name: Install apko
        uses: mattdowdell/go-installer@v0.3.0
        with:
          package: chainguard.dev/apko
      - name: Build tool
        run: go build -o dockerfiles .
      - name: Generate signing keys
        run: |
          echo "${{ secrets.MELANGE_SIGNING_KEY }}" > greboid-dockerfiles.rsa
          chmod 600 greboid-dockerfiles.rsa
          openssl rsa -in greboid-dockerfiles.rsa -pubout -out greboid-dockerfiles.rsa.pub
          chmod 644 greboid-dockerfiles.rsa.pub
      - name: Create repo directory
        run: mkdir -p repo
      - name: Build and push all containers
        run: ./dockerfiles ci --registry ${{ secrets.REGISTRY }} --update --push
