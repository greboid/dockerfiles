name: Update Containers
"on":
    workflow_dispatch: {}
    workflow_run:
        workflows:
            - Update Workflow
        types:
            - completed
concurrency: dockerfiles
permissions:
    contents: write
jobs:
    alpine:
        name: Build alpine
        needs:
            - setup-cache
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: alpine
    base:
        name: Build base
        needs:
            - setup-cache
            - baseroot
            - update-layer-1
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: base
    baseroot:
        name: Build baseroot
        needs:
            - setup-cache
            - alpine
            - update-layer-0
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: baseroot
    centauri:
        name: Build centauri
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: centauri
    commit-changes:
        name: Commit updated files
        runs-on: ubuntu-latest
        needs:
            - update-layer-4
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                token: ${{ secrets.GITHUB_TOKEN }}
            - name: Setup Go
              uses: actions/setup-go@v6
              with:
                cache: "false"
                go-version: stable
            - name: Install latest dfo
              uses: mattdowdell/go-installer@v0.3.0
              with:
                package: github.com/greboid/dfo
            - name: Update all Containerfiles with built image digests
              run: |
                set -e
                echo 'Updating all Containerfiles with built image digests...'
                dfo single -d alpine
                dfo single -d baseroot
                dfo single -d golang
                dfo single -d node
                dfo single -d rust
                dfo single -d texlive
                dfo single -d base
                dfo single -d immich
                dfo single -d centauri
                dfo single -d dockercleanup
                dfo single -d dotege
                dfo single -d dsp
                dfo single -d githubmirror
                dfo single -d golink
                dfo single -d goplum
                dfo single -d httpredirect
                dfo single -d identd
                dfo single -d irc-bot
                dfo single -d irc-distribution
                dfo single -d irc-github
                dfo single -d irc-goplum
                dfo single -d irc-notifier
                dfo single -d irc-webhook
                dfo single -d legoergo
                dfo single -d linx-server
                dfo single -d miniflux
                dfo single -d postgres-15
                dfo single -d puzzles
                dfo single -d redis
                dfo single -d registryauth
                dfo single -d soju
                dfo single -d sws
                dfo single -d thelounge
                dfo single -d tsp
                dfo single -d vaultwarden
                dfo single -d watchtower
                dfo single -d webhooked
                dfo single -d gamja
            - name: Commit and push changes
              run: |-
                git config user.name "github-actions[bot]"
                git config user.email "github-actions[bot]@users.noreply.github.com"
                git add .
                if git diff --staged --quiet; then
                  echo "No changes to commit"
                else
                  git commit -m "Update Containerfiles and BOMs with built image digests"
                  git push
                fi
    dockercleanup:
        name: Build dockercleanup
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: dockercleanup
    dotege:
        name: Build dotege
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: dotege
    dsp:
        name: Build dsp
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: dsp
    gamja:
        name: Build gamja
        needs:
            - setup-cache
            - alpine
            - base
            - node
            - sws
            - update-layer-3
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: gamja
    githubmirror:
        name: Build githubmirror
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: githubmirror
    golang:
        name: Build golang
        needs:
            - setup-cache
            - alpine
            - update-layer-0
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: golang
    golink:
        name: Build golink
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: golink
    goplum:
        name: Build goplum
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: goplum
    httpredirect:
        name: Build httpredirect
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: httpredirect
    identd:
        name: Build identd
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: identd
    immich:
        name: Build immich
        needs:
            - setup-cache
            - alpine
            - node
            - update-layer-1
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: immich
    irc-bot:
        name: Build irc-bot
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: irc-bot
    irc-distribution:
        name: Build irc-distribution
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: irc-distribution
    irc-github:
        name: Build irc-github
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: irc-github
    irc-goplum:
        name: Build irc-goplum
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: irc-goplum
    irc-notifier:
        name: Build irc-notifier
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: irc-notifier
    irc-webhook:
        name: Build irc-webhook
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: irc-webhook
    legoergo:
        name: Build legoergo
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: legoergo
    linx-server:
        name: Build linx-server
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: linx-server
    miniflux:
        name: Build miniflux
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: miniflux
    node:
        name: Build node
        needs:
            - setup-cache
            - alpine
            - update-layer-0
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: node
    postgres-15:
        name: Build postgres-15
        needs:
            - setup-cache
            - alpine
            - base
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: postgres-15
    puzzles:
        name: Build puzzles
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: puzzles
    redis:
        name: Build redis
        needs:
            - setup-cache
            - alpine
            - base
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: redis
    registryauth:
        name: Build registryauth
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: registryauth
    rust:
        name: Build rust
        needs:
            - setup-cache
            - alpine
            - update-layer-0
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: rust
    setup-cache:
        name: Setup cache
        runs-on: ubuntu-latest
        steps:
            - name: Setup Go
              uses: actions/setup-go@v6
              with:
                cache: "false"
                go-version: stable
            - name: Install latest dfo
              uses: mattdowdell/go-installer@v0.3.0
              with:
                package: github.com/greboid/dfo
    soju:
        name: Build soju
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: soju
    sws:
        name: Build sws
        needs:
            - setup-cache
            - base
            - rust
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: sws
    texlive:
        name: Build texlive
        needs:
            - setup-cache
            - alpine
            - update-layer-0
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: texlive
    thelounge:
        name: Build thelounge
        needs:
            - setup-cache
            - base
            - node
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: thelounge
    tsp:
        name: Build tsp
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: tsp
    update-layer-0:
        name: Update layer 0 tags
        runs-on: ubuntu-latest
        needs:
            - setup-cache
            - alpine
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                token: ${{ secrets.GITHUB_TOKEN }}
            - name: Setup Go
              uses: actions/setup-go@v6
              with:
                cache: "false"
                go-version: stable
            - name: Install latest dfo
              uses: mattdowdell/go-installer@v0.3.0
              with:
                package: github.com/greboid/dfo
            - name: Update layer 0 Containerfiles
              run: |
                set -e
                echo 'Updating alpine...'
                dfo single -d alpine
    update-layer-1:
        name: Update layer 1 tags
        runs-on: ubuntu-latest
        needs:
            - setup-cache
            - baseroot
            - golang
            - node
            - rust
            - texlive
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                token: ${{ secrets.GITHUB_TOKEN }}
            - name: Setup Go
              uses: actions/setup-go@v6
              with:
                cache: "false"
                go-version: stable
            - name: Install latest dfo
              uses: mattdowdell/go-installer@v0.3.0
              with:
                package: github.com/greboid/dfo
            - name: Update layer 1 Containerfiles
              run: |
                set -e
                echo 'Updating baseroot...'
                dfo single -d baseroot
                echo 'Updating golang...'
                dfo single -d golang
                echo 'Updating node...'
                dfo single -d node
                echo 'Updating rust...'
                dfo single -d rust
                echo 'Updating texlive...'
                dfo single -d texlive
    update-layer-2:
        name: Update layer 2 tags
        runs-on: ubuntu-latest
        needs:
            - setup-cache
            - base
            - immich
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                token: ${{ secrets.GITHUB_TOKEN }}
            - name: Setup Go
              uses: actions/setup-go@v6
              with:
                cache: "false"
                go-version: stable
            - name: Install latest dfo
              uses: mattdowdell/go-installer@v0.3.0
              with:
                package: github.com/greboid/dfo
            - name: Update layer 2 Containerfiles
              run: |
                set -e
                echo 'Updating base...'
                dfo single -d base
                echo 'Updating immich...'
                dfo single -d immich
    update-layer-3:
        name: Update layer 3 tags
        runs-on: ubuntu-latest
        needs:
            - setup-cache
            - centauri
            - dockercleanup
            - dotege
            - dsp
            - githubmirror
            - golink
            - goplum
            - httpredirect
            - identd
            - irc-bot
            - irc-distribution
            - irc-github
            - irc-goplum
            - irc-notifier
            - irc-webhook
            - legoergo
            - linx-server
            - miniflux
            - postgres-15
            - puzzles
            - redis
            - registryauth
            - soju
            - sws
            - thelounge
            - tsp
            - vaultwarden
            - watchtower
            - webhooked
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                token: ${{ secrets.GITHUB_TOKEN }}
            - name: Setup Go
              uses: actions/setup-go@v6
              with:
                cache: "false"
                go-version: stable
            - name: Install latest dfo
              uses: mattdowdell/go-installer@v0.3.0
              with:
                package: github.com/greboid/dfo
            - name: Update layer 3 Containerfiles
              run: |
                set -e
                echo 'Updating centauri...'
                dfo single -d centauri
                echo 'Updating dockercleanup...'
                dfo single -d dockercleanup
                echo 'Updating dotege...'
                dfo single -d dotege
                echo 'Updating dsp...'
                dfo single -d dsp
                echo 'Updating githubmirror...'
                dfo single -d githubmirror
                echo 'Updating golink...'
                dfo single -d golink
                echo 'Updating goplum...'
                dfo single -d goplum
                echo 'Updating httpredirect...'
                dfo single -d httpredirect
                echo 'Updating identd...'
                dfo single -d identd
                echo 'Updating irc-bot...'
                dfo single -d irc-bot
                echo 'Updating irc-distribution...'
                dfo single -d irc-distribution
                echo 'Updating irc-github...'
                dfo single -d irc-github
                echo 'Updating irc-goplum...'
                dfo single -d irc-goplum
                echo 'Updating irc-notifier...'
                dfo single -d irc-notifier
                echo 'Updating irc-webhook...'
                dfo single -d irc-webhook
                echo 'Updating legoergo...'
                dfo single -d legoergo
                echo 'Updating linx-server...'
                dfo single -d linx-server
                echo 'Updating miniflux...'
                dfo single -d miniflux
                echo 'Updating postgres-15...'
                dfo single -d postgres-15
                echo 'Updating puzzles...'
                dfo single -d puzzles
                echo 'Updating redis...'
                dfo single -d redis
                echo 'Updating registryauth...'
                dfo single -d registryauth
                echo 'Updating soju...'
                dfo single -d soju
                echo 'Updating sws...'
                dfo single -d sws
                echo 'Updating thelounge...'
                dfo single -d thelounge
                echo 'Updating tsp...'
                dfo single -d tsp
                echo 'Updating vaultwarden...'
                dfo single -d vaultwarden
                echo 'Updating watchtower...'
                dfo single -d watchtower
                echo 'Updating webhooked...'
                dfo single -d webhooked
    update-layer-4:
        name: Update layer 4 tags
        runs-on: ubuntu-latest
        needs:
            - setup-cache
            - gamja
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                token: ${{ secrets.GITHUB_TOKEN }}
            - name: Setup Go
              uses: actions/setup-go@v6
              with:
                cache: "false"
                go-version: stable
            - name: Install latest dfo
              uses: mattdowdell/go-installer@v0.3.0
              with:
                package: github.com/greboid/dfo
            - name: Update layer 4 Containerfiles
              run: |
                set -e
                echo 'Updating gamja...'
                dfo single -d gamja
    vaultwarden:
        name: Build vaultwarden
        needs:
            - setup-cache
            - base
            - rust
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: vaultwarden
    watchtower:
        name: Build watchtower
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: watchtower
    webhooked:
        name: Build webhooked
        needs:
            - setup-cache
            - base
            - golang
            - update-layer-2
        uses: ./.github/workflows/container-builder.yml
        secrets: inherit
        with:
            PROJECT_NAME: webhooked
