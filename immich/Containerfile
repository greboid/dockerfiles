# BOM: {"apk:acl-libs":"2.3.2-r1","apk:alsa-lib":"1.2.14-r2","apk:aom-dev":"3.13.1-r0","apk:aom-libs":"3.13.1-r0","apk:bash":"5.3.3-r1","apk:binutils":"2.45.1-r0","apk:boost1.84-python3":"1.84.0-r3","apk:brotli":"1.2.0-r0","apk:brotli-dev":"1.2.0-r0","apk:brotli-libs":"1.2.0-r0","apk:bsd-compat-headers":"0.7.2-r6","apk:busybox":"1.37.0-r30","apk:busybox-binsh":"1.37.0-r30","apk:bzip2-dev":"1.0.8-r6","apk:c-ares":"1.34.6-r0","apk:ca-certificates-bundle":"20251003-r0","apk:cairo":"1.18.4-r0","apk:cairo-dev":"1.18.4-r0","apk:cairo-gobject":"1.18.4-r0","apk:cairo-tools":"1.18.4-r0","apk:cfitsio":"4.6.3-r0","apk:cfitsio-dev":"4.6.3-r0","apk:cgif":"0.5.0-r1","apk:cgif-dev":"0.5.0-r1","apk:cjson":"1.7.19-r1","apk:curl":"8.17.0-r1","apk:dav1d-dev":"1.5.2-r0","apk:dbus-libs":"1.16.2-r1","apk:docbook-xml":"4.5-r10","apk:docbook-xsl":"1.79.2-r13","apk:docbook-xsl-nons":"1.79.2-r13","apk:docbook-xsl-ns":"1.79.2-r13","apk:exiftool":"13.36-r0","apk:expat":"2.7.3-r0","apk:expat-dev":"2.7.3-r0","apk:ffmpeg":"8.0.1-r0","apk:ffmpeg-dev":"8.0.1-r0","apk:ffmpeg-libavcodec":"8.0.1-r0","apk:ffmpeg-libavdevice":"8.0.1-r0","apk:ffmpeg-libavfilter":"8.0.1-r0","apk:ffmpeg-libavformat":"8.0.1-r0","apk:ffmpeg-libavutil":"8.0.1-r0","apk:ffmpeg-libswresample":"8.0.1-r0","apk:ffmpeg-libswscale":"8.0.1-r0","apk:fftw-dev":"3.3.10-r7","apk:fftw-double-libs":"3.3.10-r7","apk:fftw-long-double-libs":"3.3.10-r7","apk:fftw-single-libs":"3.3.10-r7","apk:fontconfig":"2.17.1-r0","apk:fontconfig-dev":"2.17.1-r0","apk:freetype":"2.14.1-r0","apk:freetype-dev":"2.14.1-r0","apk:fribidi":"1.0.16-r2","apk:fribidi-dev":"1.0.16-r2","apk:g++":"15.2.0-r2","apk:gcc":"15.2.0-r2","apk:gdbm":"1.26-r0","apk:gdk-pixbuf":"2.44.4-r0","apk:gdk-pixbuf-dev":"2.44.4-r0","apk:gettext":"0.24.1-r1","apk:gettext-asprintf":"0.24.1-r1","apk:gettext-dev":"0.24.1-r1","apk:gettext-envsubst":"0.24.1-r1","apk:gettext-libs":"0.24.1-r1","apk:git":"2.52.0-r0","apk:glib":"2.86.3-r0","apk:glib-dev":"2.86.3-r0","apk:glslang-libs":"1.4.321.0-r0","apk:gmock":"1.17.0-r0","apk:gmp":"6.3.0-r4","apk:graphite2":"1.3.14-r6","apk:graphite2-dev":"1.3.14-r6","apk:gtest":"1.17.0-r0","apk:gtest-dev":"1.17.0-r0","apk:harfbuzz":"12.2.0-r0","apk:harfbuzz-cairo":"12.2.0-r0","apk:harfbuzz-dev":"12.2.0-r0","apk:harfbuzz-gobject":"12.2.0-r0","apk:harfbuzz-icu":"12.2.0-r0","apk:harfbuzz-subset":"12.2.0-r0","apk:highway-dev":"1.3.0-r0","apk:hwdata-pci":"0.401-r0","apk:icu":"76.1-r1","apk:icu-data-en":"76.1-r1","apk:icu-dev":"76.1-r1","apk:icu-libs":"76.1-r1","apk:imagemagick":"7.1.2.8-r0","apk:imagemagick-libs":"7.1.2.8-r0","apk:imath":"3.1.12-r0","apk:imath-dev":"3.1.12-r0","apk:isl25":"0.25-r2","apk:jansson":"2.14.1-r0","apk:json-c":"0.18-r1","apk:lame-libs":"3.100-r5","apk:lcms2":"2.17-r0","apk:lcms2-dev":"2.17-r0","apk:lcms2-plugins":"2.17-r0","apk:libSvtAv1Enc":"3.1.2-r0","apk:libarchive":"3.8.4-r0","apk:libarchive-dev":"3.8.4-r0","apk:libass":"0.17.4-r0","apk:libasyncns":"0.8-r4","apk:libatomic":"15.2.0-r2","apk:libblkid":"2.41.2-r0","apk:libbluray":"1.4.0-r0","apk:libbsd":"0.12.2-r0","apk:libbz2":"1.0.8-r6","apk:libcrypto3":"3.5.4-r0","apk:libcurl":"8.17.0-r1","apk:libdav1d":"1.5.2-r0","apk:libde265":"1.0.16-r0","apk:libde265-dev":"1.0.16-r0","apk:libdeflate":"1.25-r0","apk:libdeflate-dev":"1.25-r0","apk:libdeflate-static":"1.25-r0","apk:libdovi":"3.3.2-r0","apk:libdrm":"2.4.131-r0","apk:libeconf":"0.8.0-r0","apk:libedit":"20251016.3.1-r0","apk:libedit-dev":"20251016.3.1-r0","apk:libexif":"0.6.25-r0","apk:libexif-dev":"0.6.25-r0","apk:libexpat":"2.7.3-r0","apk:libfdisk":"2.41.2-r0","apk:libffi":"3.5.2-r0","apk:libffi-dev":"3.5.2-r0","apk:libflac":"1.4.3-r2","apk:libformw":"6.5_p20251123-r0","apk:libgcc":"15.2.0-r2","apk:libgomp":"15.2.0-r2","apk:libheif":"1.20.2-r1","apk:libheif-dev":"1.20.2-r1","apk:libhwy":"1.3.0-r0","apk:libhwy_contrib":"1.3.0-r0","apk:libhwy_test":"1.3.0-r0","apk:libidn2":"2.3.8-r0","apk:libimagequant":"4.2.2-r0","apk:libimagequant-dev":"4.2.2-r0","apk:libintl":"0.24.1-r1","apk:libjpeg-turbo":"3.1.2-r0","apk:libjpeg-turbo-dev":"3.1.2-r0","apk:libjxl":"0.11.1-r3","apk:liblastlog2":"2.41.2-r0","apk:libltdl":"2.5.4-r2","apk:libmd":"1.1.0-r0","apk:libmenuw":"6.5_p20251123-r0","apk:libmount":"2.41.2-r0","apk:libncurses++":"6.5_p20251123-r0","apk:libncursesw":"6.5_p20251123-r0","apk:libogg":"1.3.6-r0","apk:libopenmpt":"0.8.3-r0","apk:libpanelw":"6.5_p20251123-r0","apk:libpciaccess":"0.18.1-r1","apk:libpcre2-16":"10.47-r0","apk:libpcre2-32":"10.47-r0","apk:libplacebo":"7.351.0-r0","apk:libpng":"1.6.53-r0","apk:libpng-dev":"1.6.53-r0","apk:libpsl":"0.21.5-r3","apk:libpulse":"17.0-r5","apk:libraqm":"0.10.2-r0","apk:librist":"0.2.10-r1","apk:librsvg":"2.61.2-r0","apk:librsvg-dev":"2.61.2-r0","apk:libsharpyuv":"1.6.0-r0","apk:libsmartcols":"2.41.2-r0","apk:libsndfile":"1.2.2-r2","apk:libsodium":"1.0.20-r0","apk:libspng":"0.7.4-r1","apk:libspng-dev":"0.7.4-r1","apk:libsrt":"1.5.3-r1","apk:libssh":"0.11.3-r0","apk:libssl3":"3.5.4-r0","apk:libstdc++":"15.2.0-r2","apk:libstdc++-dev":"15.2.0-r2","apk:libtheora":"1.2.0-r0","apk:libtiffxx":"4.7.1-r0","apk:libturbojpeg":"3.1.2-r0","apk:libudfread":"1.2.0-r0","apk:libunibreak":"6.1-r0","apk:libunistring":"1.4.1-r0","apk:libuuid":"2.41.2-r0","apk:libva":"2.22.0-r1","apk:libvdpau":"1.5-r4","apk:libvorbis":"1.3.7-r2","apk:libvpl":"2.15.0-r1","apk:libvpx":"1.15.2-r0","apk:libwebp":"1.6.0-r0","apk:libwebp-dev":"1.6.0-r0","apk:libwebpdecoder":"1.6.0-r0","apk:libwebpdemux":"1.6.0-r0","apk:libwebpmux":"1.6.0-r0","apk:libx11":"1.8.12-r1","apk:libx11-dev":"1.8.12-r1","apk:libxau":"1.0.12-r0","apk:libxau-dev":"1.0.12-r0","apk:libxcb":"1.17.0-r1","apk:libxcb-dev":"1.17.0-r1","apk:libxdmcp":"1.1.5-r1","apk:libxdmcp-dev":"1.1.5-r1","apk:libxext":"1.3.6-r2","apk:libxext-dev":"1.3.6-r2","apk:libxfixes":"6.0.2-r0","apk:libxft":"2.3.9-r0","apk:libxft-dev":"2.3.9-r0","apk:libxml2":"2.13.9-r0","apk:libxml2-dev":"2.13.9-r0","apk:libxml2-utils":"2.13.9-r0","apk:libxrender":"0.9.12-r0","apk:libxrender-dev":"0.9.12-r0","apk:libxslt":"1.1.43-r3","apk:libxxhash":"0.8.3-r0","apk:libzmq":"4.3.5-r2","apk:lilv-libs":"0.24.26-r0","apk:linux-headers":"6.16.12-r0","apk:lua5.1-libs":"5.1.5-r13","apk:lz4-libs":"1.10.0-r0","apk:make":"4.4.1-r3","apk:mbedtls":"3.6.5-r0","apk:mise":"2025.8.20-r0","apk:mpc1":"1.3.1-r1","apk:mpdecimal":"4.0.1-r0","apk:mpfr4":"4.2.2-r0","apk:mpg123-libs":"1.33.3-r0","apk:musl":"1.2.5-r21","apk:musl-dev":"1.2.5-r21","apk:ncurses-dev":"6.5_p20251123-r0","apk:ncurses-terminfo-base":"6.5_p20251123-r0","apk:nghttp2-libs":"1.68.0-r0","apk:nghttp3":"1.13.1-r0","apk:numactl":"2.0.18-r0","apk:openexr":"3.4.2-r0","apk:openexr-dev":"3.4.2-r0","apk:openexr-libiex":"3.4.2-r0","apk:openexr-libilmthread":"3.4.2-r0","apk:openexr-libopenexr":"3.4.2-r0","apk:openexr-libopenexrcore":"3.4.2-r0","apk:openexr-libopenexrutil":"3.4.2-r0","apk:openjpeg":"2.5.4-r1","apk:openjpeg-dev":"2.5.4-r1","apk:openjpeg-tools":"2.5.4-r1","apk:openssl-dev":"3.5.4-r0","apk:opus":"1.5.2-r1","apk:orc":"0.4.41-r0","apk:pango":"1.56.4-r0","apk:pango-dev":"1.56.4-r0","apk:pango-tools":"1.56.4-r0","apk:pcre2":"10.47-r0","apk:pcre2-dev":"10.47-r0","apk:perl":"5.42.0-r0","apk:perl-image-exiftool":"13.36-r0","apk:pixman":"0.46.4-r0","apk:pixman-dev":"0.46.4-r0","apk:pkgconf":"2.5.1-r0","apk:popt":"1.19-r4","apk:py3-imath":"3.1.12-r0","apk:py3-packaging":"25.0-r0","apk:py3-parsing":"3.2.3-r0","apk:python3":"3.12.12-r0","apk:rav1e-libs":"0.8.1-r0","apk:readline":"8.3.1-r0","apk:rsvg-convert":"2.61.2-r0","apk:rsync":"3.4.1-r1","apk:serd-libs":"0.32.4-r0","apk:shaderc":"2025.3-r0","apk:shared-mime-info":"2.4-r6","apk:sord-libs":"0.16.18-r0","apk:soxr":"0.1.3-r7","apk:speexdsp":"1.2.1-r2","apk:spirv-tools":"1.4.321.0-r1","apk:sqlite":"3.51.1-r0","apk:sqlite-dev":"3.51.1-r0","apk:sqlite-libs":"3.51.1-r0","apk:sratom":"0.6.18-r0","apk:tdb-libs":"1.4.14-r0","apk:tiff":"4.7.1-r0","apk:tiff-dev":"4.7.1-r0","apk:unzip":"6.0-r16","apk:util-linux-dev":"2.41.2-r0","apk:util-macros":"1.20.2-r0","apk:v4l-utils-libs":"1.32.0-r0","apk:vidstab":"1.1.1-r0","apk:vips":"8.17.3-r1","apk:vips-cpp":"8.17.3-r1","apk:vips-dev":"8.17.3-r1","apk:vulkan-loader":"1.4.321.0-r0","apk:wayland-libs-client":"1.24.0-r0","apk:x264-libs":"0.164.3108-r1","apk:x265-dev":"4.1-r0","apk:x265-libs":"4.1-r0","apk:xcb-proto":"1.17.0-r0","apk:xcb-util":"0.4.1-r3","apk:xcb-util-dev":"0.4.1-r3","apk:xorgproto":"2024.1-r0","apk:xtrans":"1.6.0-r0","apk:xvidcore":"1.3.7-r2","apk:xz":"5.8.1-r0","apk:xz-dev":"5.8.1-r0","apk:xz-libs":"5.8.1-r0","apk:zimg":"3.0.6-r0","apk:zix-libs":"0.6.2-r0","apk:zlib":"1.3.1-r2","apk:zlib-dev":"1.3.1-r2","apk:zstd":"1.5.7-r2","apk:zstd-dev":"1.5.7-r2","apk:zstd-libs":"1.5.7-r2","https://github.com/immich-app/immich":"v2.4.1","image:alpine":"82be29135bb710d4d12e4ff42645894d024a00efab45bf6aa01693df7595e77a","image:node":"a85e7e8102b80224985b68c759f945465dcf06b87118cd71589fbe9bf7ee5dfa"}

FROM reg.g5d.dev/alpine@sha256:82be29135bb710d4d12e4ff42645894d024a00efab45bf6aa01693df7595e77a AS geodata

WORKDIR /build/geodata

# Download geodata files
RUN apk add --no-cache --virtual .build-deps \
  brotli-libs=1.2.0-r0 \
  c-ares=1.34.6-r0 \
  ca-certificates-bundle=20251003-r0 \
  curl=8.17.0-r1 \
  libcrypto3=3.5.4-r0 \
  libcurl=8.17.0-r1 \
  libidn2=2.3.8-r0 \
  libpsl=0.21.5-r3 \
  libssl3=3.5.4-r0 \
  libunistring=1.4.1-r0 \
  musl=1.2.5-r21 \
  nghttp2-libs=1.68.0-r0 \
  nghttp3=1.13.1-r0 \
  unzip=6.0-r16 \
  zlib=1.3.1-r2 \
  zstd-libs=1.5.7-r2 \
  ; \
  set -eux; \
  curl -fsSL -o /build/geodata/cities500.zip https://download.geonames.org/export/dump/cities500.zip; \
  curl -fsSL -o /build/geodata/admin1CodesASCII.txt https://download.geonames.org/export/dump/admin1CodesASCII.txt; \
  curl -fsSL -o /build/geodata/admin2Codes.txt https://download.geonames.org/export/dump/admin2Codes.txt; \
  curl -fsSL -o /build/geodata/ne_10m_admin_0_countries.geojson https://raw.githubusercontent.com/nvkelso/natural-earth-vector/v5.1.2/geojson/ne_10m_admin_0_countries.geojson; \
  unzip /build/geodata/cities500.zip -d /build/geodata/; \
  date --iso-8601=seconds | tr -d "\n" > /build/geodata/geodata-date.txt; \
  apk del --no-network .build-deps


FROM reg.g5d.dev/node@sha256:a85e7e8102b80224985b68c759f945465dcf06b87118cd71589fbe9bf7ee5dfa AS builder

WORKDIR /app

# Clone and build immich-server
RUN apk add --no-cache --virtual .build-deps \
  acl-libs=2.3.2-r1 \
  alsa-lib=1.2.14-r2 \
  aom-dev=3.13.1-r0 \
  aom-libs=3.13.1-r0 \
  binutils=2.45.1-r0 \
  boost1.84-python3=1.84.0-r3 \
  brotli=1.2.0-r0 \
  brotli-dev=1.2.0-r0 \
  brotli-libs=1.2.0-r0 \
  bsd-compat-headers=0.7.2-r6 \
  busybox=1.37.0-r30 \
  busybox-binsh=1.37.0-r30 \
  bzip2-dev=1.0.8-r6 \
  c-ares=1.34.6-r0 \
  ca-certificates-bundle=20251003-r0 \
  cairo=1.18.4-r0 \
  cairo-dev=1.18.4-r0 \
  cairo-gobject=1.18.4-r0 \
  cairo-tools=1.18.4-r0 \
  cfitsio=4.6.3-r0 \
  cfitsio-dev=4.6.3-r0 \
  cgif=0.5.0-r1 \
  cgif-dev=0.5.0-r1 \
  cjson=1.7.19-r1 \
  dav1d-dev=1.5.2-r0 \
  dbus-libs=1.16.2-r1 \
  docbook-xml=4.5-r10 \
  docbook-xsl=1.79.2-r13 \
  docbook-xsl-nons=1.79.2-r13 \
  docbook-xsl-ns=1.79.2-r13 \
  expat=2.7.3-r0 \
  expat-dev=2.7.3-r0 \
  ffmpeg-dev=8.0.1-r0 \
  ffmpeg-libavcodec=8.0.1-r0 \
  ffmpeg-libavdevice=8.0.1-r0 \
  ffmpeg-libavfilter=8.0.1-r0 \
  ffmpeg-libavformat=8.0.1-r0 \
  ffmpeg-libavutil=8.0.1-r0 \
  ffmpeg-libswresample=8.0.1-r0 \
  ffmpeg-libswscale=8.0.1-r0 \
  fftw-dev=3.3.10-r7 \
  fftw-double-libs=3.3.10-r7 \
  fftw-long-double-libs=3.3.10-r7 \
  fftw-single-libs=3.3.10-r7 \
  fontconfig=2.17.1-r0 \
  fontconfig-dev=2.17.1-r0 \
  freetype=2.14.1-r0 \
  freetype-dev=2.14.1-r0 \
  fribidi=1.0.16-r2 \
  fribidi-dev=1.0.16-r2 \
  g++=15.2.0-r2 \
  gcc=15.2.0-r2 \
  gdbm=1.26-r0 \
  gdk-pixbuf=2.44.4-r0 \
  gdk-pixbuf-dev=2.44.4-r0 \
  gettext=0.24.1-r1 \
  gettext-asprintf=0.24.1-r1 \
  gettext-dev=0.24.1-r1 \
  gettext-envsubst=0.24.1-r1 \
  gettext-libs=0.24.1-r1 \
  git=2.52.0-r0 \
  glib=2.86.3-r0 \
  glib-dev=2.86.3-r0 \
  glslang-libs=1.4.321.0-r0 \
  gmock=1.17.0-r0 \
  gmp=6.3.0-r4 \
  graphite2=1.3.14-r6 \
  graphite2-dev=1.3.14-r6 \
  gtest=1.17.0-r0 \
  gtest-dev=1.17.0-r0 \
  harfbuzz=12.2.0-r0 \
  harfbuzz-cairo=12.2.0-r0 \
  harfbuzz-dev=12.2.0-r0 \
  harfbuzz-gobject=12.2.0-r0 \
  harfbuzz-icu=12.2.0-r0 \
  harfbuzz-subset=12.2.0-r0 \
  highway-dev=1.3.0-r0 \
  hwdata-pci=0.401-r0 \
  icu=76.1-r1 \
  icu-data-en=76.1-r1 \
  icu-dev=76.1-r1 \
  icu-libs=76.1-r1 \
  imath=3.1.12-r0 \
  imath-dev=3.1.12-r0 \
  isl25=0.25-r2 \
  jansson=2.14.1-r0 \
  json-c=0.18-r1 \
  lame-libs=3.100-r5 \
  lcms2=2.17-r0 \
  lcms2-dev=2.17-r0 \
  lcms2-plugins=2.17-r0 \
  libSvtAv1Enc=3.1.2-r0 \
  libarchive=3.8.4-r0 \
  libarchive-dev=3.8.4-r0 \
  libass=0.17.4-r0 \
  libasyncns=0.8-r4 \
  libatomic=15.2.0-r2 \
  libblkid=2.41.2-r0 \
  libbluray=1.4.0-r0 \
  libbsd=0.12.2-r0 \
  libbz2=1.0.8-r6 \
  libcrypto3=3.5.4-r0 \
  libcurl=8.17.0-r1 \
  libdav1d=1.5.2-r0 \
  libde265=1.0.16-r0 \
  libde265-dev=1.0.16-r0 \
  libdeflate=1.25-r0 \
  libdeflate-dev=1.25-r0 \
  libdeflate-static=1.25-r0 \
  libdovi=3.3.2-r0 \
  libdrm=2.4.131-r0 \
  libeconf=0.8.0-r0 \
  libedit=20251016.3.1-r0 \
  libedit-dev=20251016.3.1-r0 \
  libexif=0.6.25-r0 \
  libexif-dev=0.6.25-r0 \
  libexpat=2.7.3-r0 \
  libfdisk=2.41.2-r0 \
  libffi=3.5.2-r0 \
  libffi-dev=3.5.2-r0 \
  libflac=1.4.3-r2 \
  libformw=6.5_p20251123-r0 \
  libgcc=15.2.0-r2 \
  libgomp=15.2.0-r2 \
  libheif=1.20.2-r1 \
  libheif-dev=1.20.2-r1 \
  libhwy=1.3.0-r0 \
  libhwy_contrib=1.3.0-r0 \
  libhwy_test=1.3.0-r0 \
  libidn2=2.3.8-r0 \
  libimagequant=4.2.2-r0 \
  libimagequant-dev=4.2.2-r0 \
  libintl=0.24.1-r1 \
  libjpeg-turbo=3.1.2-r0 \
  libjpeg-turbo-dev=3.1.2-r0 \
  libjxl=0.11.1-r3 \
  liblastlog2=2.41.2-r0 \
  libltdl=2.5.4-r2 \
  libmd=1.1.0-r0 \
  libmenuw=6.5_p20251123-r0 \
  libmount=2.41.2-r0 \
  libncurses++=6.5_p20251123-r0 \
  libncursesw=6.5_p20251123-r0 \
  libogg=1.3.6-r0 \
  libopenmpt=0.8.3-r0 \
  libpanelw=6.5_p20251123-r0 \
  libpciaccess=0.18.1-r1 \
  libpcre2-16=10.47-r0 \
  libpcre2-32=10.47-r0 \
  libplacebo=7.351.0-r0 \
  libpng=1.6.53-r0 \
  libpng-dev=1.6.53-r0 \
  libpsl=0.21.5-r3 \
  libpulse=17.0-r5 \
  librist=0.2.10-r1 \
  librsvg=2.61.2-r0 \
  librsvg-dev=2.61.2-r0 \
  libsharpyuv=1.6.0-r0 \
  libsmartcols=2.41.2-r0 \
  libsndfile=1.2.2-r2 \
  libsodium=1.0.20-r0 \
  libspng=0.7.4-r1 \
  libspng-dev=0.7.4-r1 \
  libsrt=1.5.3-r1 \
  libssh=0.11.3-r0 \
  libssl3=3.5.4-r0 \
  libstdc++=15.2.0-r2 \
  libstdc++-dev=15.2.0-r2 \
  libtheora=1.2.0-r0 \
  libtiffxx=4.7.1-r0 \
  libturbojpeg=3.1.2-r0 \
  libudfread=1.2.0-r0 \
  libunibreak=6.1-r0 \
  libunistring=1.4.1-r0 \
  libuuid=2.41.2-r0 \
  libva=2.22.0-r1 \
  libvdpau=1.5-r4 \
  libvorbis=1.3.7-r2 \
  libvpl=2.15.0-r1 \
  libvpx=1.15.2-r0 \
  libwebp=1.6.0-r0 \
  libwebp-dev=1.6.0-r0 \
  libwebpdecoder=1.6.0-r0 \
  libwebpdemux=1.6.0-r0 \
  libwebpmux=1.6.0-r0 \
  libx11=1.8.12-r1 \
  libx11-dev=1.8.12-r1 \
  libxau=1.0.12-r0 \
  libxau-dev=1.0.12-r0 \
  libxcb=1.17.0-r1 \
  libxcb-dev=1.17.0-r1 \
  libxdmcp=1.1.5-r1 \
  libxdmcp-dev=1.1.5-r1 \
  libxext=1.3.6-r2 \
  libxext-dev=1.3.6-r2 \
  libxfixes=6.0.2-r0 \
  libxft=2.3.9-r0 \
  libxft-dev=2.3.9-r0 \
  libxml2=2.13.9-r0 \
  libxml2-dev=2.13.9-r0 \
  libxml2-utils=2.13.9-r0 \
  libxrender=0.9.12-r0 \
  libxrender-dev=0.9.12-r0 \
  libxslt=1.1.43-r3 \
  libzmq=4.3.5-r2 \
  lilv-libs=0.24.26-r0 \
  linux-headers=6.16.12-r0 \
  lz4-libs=1.10.0-r0 \
  make=4.4.1-r3 \
  mbedtls=3.6.5-r0 \
  mpc1=1.3.1-r1 \
  mpdecimal=4.0.1-r0 \
  mpfr4=4.2.2-r0 \
  mpg123-libs=1.33.3-r0 \
  musl=1.2.5-r21 \
  musl-dev=1.2.5-r21 \
  ncurses-dev=6.5_p20251123-r0 \
  ncurses-terminfo-base=6.5_p20251123-r0 \
  nghttp2-libs=1.68.0-r0 \
  nghttp3=1.13.1-r0 \
  numactl=2.0.18-r0 \
  openexr=3.4.2-r0 \
  openexr-dev=3.4.2-r0 \
  openexr-libiex=3.4.2-r0 \
  openexr-libilmthread=3.4.2-r0 \
  openexr-libopenexr=3.4.2-r0 \
  openexr-libopenexrcore=3.4.2-r0 \
  openexr-libopenexrutil=3.4.2-r0 \
  openjpeg=2.5.4-r1 \
  openjpeg-dev=2.5.4-r1 \
  openjpeg-tools=2.5.4-r1 \
  openssl-dev=3.5.4-r0 \
  opus=1.5.2-r1 \
  orc=0.4.41-r0 \
  pango=1.56.4-r0 \
  pango-dev=1.56.4-r0 \
  pango-tools=1.56.4-r0 \
  pcre2=10.47-r0 \
  pcre2-dev=10.47-r0 \
  perl=5.42.0-r0 \
  pixman=0.46.4-r0 \
  pixman-dev=0.46.4-r0 \
  pkgconf=2.5.1-r0 \
  py3-imath=3.1.12-r0 \
  py3-packaging=25.0-r0 \
  py3-parsing=3.2.3-r0 \
  python3=3.12.12-r0 \
  rav1e-libs=0.8.1-r0 \
  readline=8.3.1-r0 \
  rsvg-convert=2.61.2-r0 \
  serd-libs=0.32.4-r0 \
  shaderc=2025.3-r0 \
  shared-mime-info=2.4-r6 \
  sord-libs=0.16.18-r0 \
  soxr=0.1.3-r7 \
  speexdsp=1.2.1-r2 \
  spirv-tools=1.4.321.0-r1 \
  sqlite=3.51.1-r0 \
  sqlite-dev=3.51.1-r0 \
  sqlite-libs=3.51.1-r0 \
  sratom=0.6.18-r0 \
  tdb-libs=1.4.14-r0 \
  tiff=4.7.1-r0 \
  tiff-dev=4.7.1-r0 \
  util-linux-dev=2.41.2-r0 \
  util-macros=1.20.2-r0 \
  v4l-utils-libs=1.32.0-r0 \
  vidstab=1.1.1-r0 \
  vips=8.17.3-r1 \
  vips-cpp=8.17.3-r1 \
  vips-dev=8.17.3-r1 \
  vulkan-loader=1.4.321.0-r0 \
  wayland-libs-client=1.24.0-r0 \
  x264-libs=0.164.3108-r1 \
  x265-dev=4.1-r0 \
  x265-libs=4.1-r0 \
  xcb-proto=1.17.0-r0 \
  xcb-util=0.4.1-r3 \
  xcb-util-dev=0.4.1-r3 \
  xorgproto=2024.1-r0 \
  xtrans=1.6.0-r0 \
  xvidcore=1.3.7-r2 \
  xz=5.8.1-r0 \
  xz-dev=5.8.1-r0 \
  xz-libs=5.8.1-r0 \
  zimg=3.0.6-r0 \
  zix-libs=0.6.2-r0 \
  zlib=1.3.1-r2 \
  zlib-dev=1.3.1-r2 \
  zstd=1.5.7-r2 \
  zstd-dev=1.5.7-r2 \
  zstd-libs=1.5.7-r2 \
  ; \
  set -eux; \
  export CI=true; \
  git clone --branch v2.4.1 --single-branch https://github.com/immich-app/immich.git; \
  cd immich; \
  pnpm install --frozen-lockfile; \
  SHARP_IGNORE_GLOBAL_LIBVIPS=true pnpm --filter immich --frozen-lockfile build; \
  SHARP_FORCE_GLOBAL_LIBVIPS=true pnpm --filter immich --frozen-lockfile --prod --no-optional deploy /app/server-deploy; \
  # Verify dist directory exists in deployment; \
  ls -la /app/server-deploy/dist/ || (echo "ERROR: dist directory not found!" && exit 1); \
  apk del --no-network .build-deps


FROM reg.g5d.dev/node@sha256:a85e7e8102b80224985b68c759f945465dcf06b87118cd71589fbe9bf7ee5dfa AS plugins

WORKDIR /app

# Copy immich repo and build plugins
COPY --from=builder /app/immich /app/immich

# Install mise and build plugins
RUN apk add --no-cache --virtual .build-deps \
  bash=5.3.3-r1 \
  brotli-libs=1.2.0-r0 \
  busybox=1.37.0-r30 \
  busybox-binsh=1.37.0-r30 \
  c-ares=1.34.6-r0 \
  ca-certificates-bundle=20251003-r0 \
  curl=8.17.0-r1 \
  libbz2=1.0.8-r6 \
  libcrypto3=3.5.4-r0 \
  libcurl=8.17.0-r1 \
  libgcc=15.2.0-r2 \
  libidn2=2.3.8-r0 \
  libncursesw=6.5_p20251123-r0 \
  libpsl=0.21.5-r3 \
  libssl3=3.5.4-r0 \
  libunistring=1.4.1-r0 \
  lua5.1-libs=5.1.5-r13 \
  mise=2025.8.20-r0 \
  musl=1.2.5-r21 \
  ncurses-terminfo-base=6.5_p20251123-r0 \
  nghttp2-libs=1.68.0-r0 \
  nghttp3=1.13.1-r0 \
  readline=8.3.1-r0 \
  zlib=1.3.1-r2 \
  zstd-libs=1.5.7-r2 \
  ; \
  set -eux; \
  # Work only in plugins directory to avoid parent mise.toml; \
  cd /app/immich/plugins; \
  mise trust; \
  # Install tools via mise; \
  mise install; \
  # Build plugins; \
  mise run build; \
  apk del --no-network .build-deps


FROM reg.g5d.dev/alpine@sha256:82be29135bb710d4d12e4ff42645894d024a00efab45bf6aa01693df7595e77a AS rootfs

# Install packages
RUN set -eux; \
    apk add --no-cache \
        acl-libs=2.3.2-r1 \
        bash=5.3.3-r1 \
        busybox=1.37.0-r30 \
        busybox-binsh=1.37.0-r30 \
        libncursesw=6.5_p20251123-r0 \
        libxxhash=0.8.3-r0 \
        lz4-libs=1.10.0-r0 \
        musl=1.2.5-r21 \
        ncurses-terminfo-base=6.5_p20251123-r0 \
        popt=1.19-r4 \
        readline=8.3.1-r0 \
        rsync=3.4.1-r1 \
        zlib=1.3.1-r2 \
        zstd-libs=1.5.7-r2 \
    ;

# Install packages into rootfs
RUN \
    apk add --no-cache acl-libs=2.3.2-r1; \
    apk info -qL acl-libs | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache alsa-lib=1.2.14-r2; \
    apk info -qL alsa-lib | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache aom-libs=3.13.1-r0; \
    apk info -qL aom-libs | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache brotli-libs=1.2.0-r0; \
    apk info -qL brotli-libs | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache busybox=1.37.0-r30; \
    apk info -qL busybox | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache busybox-binsh=1.37.0-r30; \
    apk info -qL busybox-binsh | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache c-ares=1.34.6-r0; \
    apk info -qL c-ares | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache ca-certificates-bundle=20251003-r0; \
    apk info -qL ca-certificates-bundle | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache cairo=1.18.4-r0; \
    apk info -qL cairo | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache cfitsio=4.6.3-r0; \
    apk info -qL cfitsio | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache cgif=0.5.0-r1; \
    apk info -qL cgif | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache cjson=1.7.19-r1; \
    apk info -qL cjson | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache dbus-libs=1.16.2-r1; \
    apk info -qL dbus-libs | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache exiftool=13.36-r0; \
    apk info -qL exiftool | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache ffmpeg=8.0.1-r0; \
    apk info -qL ffmpeg | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache ffmpeg-libavcodec=8.0.1-r0; \
    apk info -qL ffmpeg-libavcodec | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache ffmpeg-libavdevice=8.0.1-r0; \
    apk info -qL ffmpeg-libavdevice | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache ffmpeg-libavfilter=8.0.1-r0; \
    apk info -qL ffmpeg-libavfilter | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache ffmpeg-libavformat=8.0.1-r0; \
    apk info -qL ffmpeg-libavformat | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache ffmpeg-libavutil=8.0.1-r0; \
    apk info -qL ffmpeg-libavutil | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache ffmpeg-libswresample=8.0.1-r0; \
    apk info -qL ffmpeg-libswresample | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache ffmpeg-libswscale=8.0.1-r0; \
    apk info -qL ffmpeg-libswscale | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache fftw-double-libs=3.3.10-r7; \
    apk info -qL fftw-double-libs | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache fontconfig=2.17.1-r0; \
    apk info -qL fontconfig | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache freetype=2.14.1-r0; \
    apk info -qL freetype | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache fribidi=1.0.16-r2; \
    apk info -qL fribidi | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache gdk-pixbuf=2.44.4-r0; \
    apk info -qL gdk-pixbuf | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache glib=2.86.3-r0; \
    apk info -qL glib | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache glslang-libs=1.4.321.0-r0; \
    apk info -qL glslang-libs | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache graphite2=1.3.14-r6; \
    apk info -qL graphite2 | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache harfbuzz=12.2.0-r0; \
    apk info -qL harfbuzz | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache hwdata-pci=0.401-r0; \
    apk info -qL hwdata-pci | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache imagemagick=7.1.2.8-r0; \
    apk info -qL imagemagick | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache imagemagick-libs=7.1.2.8-r0; \
    apk info -qL imagemagick-libs | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache imath=3.1.12-r0; \
    apk info -qL imath | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache json-c=0.18-r1; \
    apk info -qL json-c | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache lame-libs=3.100-r5; \
    apk info -qL lame-libs | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache lcms2=2.17-r0; \
    apk info -qL lcms2 | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libSvtAv1Enc=3.1.2-r0; \
    apk info -qL libSvtAv1Enc | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libarchive=3.8.4-r0; \
    apk info -qL libarchive | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libass=0.17.4-r0; \
    apk info -qL libass | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libasyncns=0.8-r4; \
    apk info -qL libasyncns | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libblkid=2.41.2-r0; \
    apk info -qL libblkid | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libbluray=1.4.0-r0; \
    apk info -qL libbluray | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libbsd=0.12.2-r0; \
    apk info -qL libbsd | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libbz2=1.0.8-r6; \
    apk info -qL libbz2 | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libcrypto3=3.5.4-r0; \
    apk info -qL libcrypto3 | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libcurl=8.17.0-r1; \
    apk info -qL libcurl | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libdav1d=1.5.2-r0; \
    apk info -qL libdav1d | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libde265=1.0.16-r0; \
    apk info -qL libde265 | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libdeflate=1.25-r0; \
    apk info -qL libdeflate | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libdovi=3.3.2-r0; \
    apk info -qL libdovi | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libdrm=2.4.131-r0; \
    apk info -qL libdrm | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libeconf=0.8.0-r0; \
    apk info -qL libeconf | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libexif=0.6.25-r0; \
    apk info -qL libexif | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libexpat=2.7.3-r0; \
    apk info -qL libexpat | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libffi=3.5.2-r0; \
    apk info -qL libffi | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libflac=1.4.3-r2; \
    apk info -qL libflac | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libgcc=15.2.0-r2; \
    apk info -qL libgcc | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libgomp=15.2.0-r2; \
    apk info -qL libgomp | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libheif=1.20.2-r1; \
    apk info -qL libheif | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libhwy=1.3.0-r0; \
    apk info -qL libhwy | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libidn2=2.3.8-r0; \
    apk info -qL libidn2 | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libimagequant=4.2.2-r0; \
    apk info -qL libimagequant | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libintl=0.24.1-r1; \
    apk info -qL libintl | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libjpeg-turbo=3.1.2-r0; \
    apk info -qL libjpeg-turbo | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libjxl=0.11.1-r3; \
    apk info -qL libjxl | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libltdl=2.5.4-r2; \
    apk info -qL libltdl | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libmd=1.1.0-r0; \
    apk info -qL libmd | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libmount=2.41.2-r0; \
    apk info -qL libmount | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libogg=1.3.6-r0; \
    apk info -qL libogg | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libopenmpt=0.8.3-r0; \
    apk info -qL libopenmpt | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libpciaccess=0.18.1-r1; \
    apk info -qL libpciaccess | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libplacebo=7.351.0-r0; \
    apk info -qL libplacebo | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libpng=1.6.53-r0; \
    apk info -qL libpng | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libpsl=0.21.5-r3; \
    apk info -qL libpsl | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libpulse=17.0-r5; \
    apk info -qL libpulse | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libraqm=0.10.2-r0; \
    apk info -qL libraqm | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache librist=0.2.10-r1; \
    apk info -qL librist | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache librsvg=2.61.2-r0; \
    apk info -qL librsvg | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libsharpyuv=1.6.0-r0; \
    apk info -qL libsharpyuv | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libsndfile=1.2.2-r2; \
    apk info -qL libsndfile | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libsodium=1.0.20-r0; \
    apk info -qL libsodium | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libspng=0.7.4-r1; \
    apk info -qL libspng | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libsrt=1.5.3-r1; \
    apk info -qL libsrt | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libssh=0.11.3-r0; \
    apk info -qL libssh | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libssl3=3.5.4-r0; \
    apk info -qL libssl3 | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libstdc++=15.2.0-r2; \
    apk info -qL libstdc++ | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libtheora=1.2.0-r0; \
    apk info -qL libtheora | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libudfread=1.2.0-r0; \
    apk info -qL libudfread | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libunibreak=6.1-r0; \
    apk info -qL libunibreak | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libunistring=1.4.1-r0; \
    apk info -qL libunistring | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libva=2.22.0-r1; \
    apk info -qL libva | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libvdpau=1.5-r4; \
    apk info -qL libvdpau | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libvorbis=1.3.7-r2; \
    apk info -qL libvorbis | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libvpl=2.15.0-r1; \
    apk info -qL libvpl | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libvpx=1.15.2-r0; \
    apk info -qL libvpx | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libwebp=1.6.0-r0; \
    apk info -qL libwebp | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libwebpdemux=1.6.0-r0; \
    apk info -qL libwebpdemux | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libwebpmux=1.6.0-r0; \
    apk info -qL libwebpmux | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libx11=1.8.12-r1; \
    apk info -qL libx11 | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libxau=1.0.12-r0; \
    apk info -qL libxau | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libxcb=1.17.0-r1; \
    apk info -qL libxcb | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libxdmcp=1.1.5-r1; \
    apk info -qL libxdmcp | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libxext=1.3.6-r2; \
    apk info -qL libxext | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libxfixes=6.0.2-r0; \
    apk info -qL libxfixes | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libxft=2.3.9-r0; \
    apk info -qL libxft | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libxml2=2.13.9-r0; \
    apk info -qL libxml2 | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libxrender=0.9.12-r0; \
    apk info -qL libxrender | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache libzmq=4.3.5-r2; \
    apk info -qL libzmq | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache lilv-libs=0.24.26-r0; \
    apk info -qL lilv-libs | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache lz4-libs=1.10.0-r0; \
    apk info -qL lz4-libs | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache mbedtls=3.6.5-r0; \
    apk info -qL mbedtls | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache mpg123-libs=1.33.3-r0; \
    apk info -qL mpg123-libs | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache musl=1.2.5-r21; \
    apk info -qL musl | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache nghttp2-libs=1.68.0-r0; \
    apk info -qL nghttp2-libs | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache nghttp3=1.13.1-r0; \
    apk info -qL nghttp3 | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache numactl=2.0.18-r0; \
    apk info -qL numactl | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache openexr=3.4.2-r0; \
    apk info -qL openexr | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache openexr-libiex=3.4.2-r0; \
    apk info -qL openexr-libiex | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache openexr-libilmthread=3.4.2-r0; \
    apk info -qL openexr-libilmthread | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache openexr-libopenexr=3.4.2-r0; \
    apk info -qL openexr-libopenexr | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache openexr-libopenexrcore=3.4.2-r0; \
    apk info -qL openexr-libopenexrcore | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache openjpeg=2.5.4-r1; \
    apk info -qL openjpeg | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache opus=1.5.2-r1; \
    apk info -qL opus | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache orc=0.4.41-r0; \
    apk info -qL orc | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache pango=1.56.4-r0; \
    apk info -qL pango | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache pcre2=10.47-r0; \
    apk info -qL pcre2 | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache perl=5.42.0-r0; \
    apk info -qL perl | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache perl-image-exiftool=13.36-r0; \
    apk info -qL perl-image-exiftool | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache pixman=0.46.4-r0; \
    apk info -qL pixman | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache pkgconf=2.5.1-r0; \
    apk info -qL pkgconf | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache rav1e-libs=0.8.1-r0; \
    apk info -qL rav1e-libs | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache serd-libs=0.32.4-r0; \
    apk info -qL serd-libs | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache shaderc=2025.3-r0; \
    apk info -qL shaderc | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache shared-mime-info=2.4-r6; \
    apk info -qL shared-mime-info | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache sord-libs=0.16.18-r0; \
    apk info -qL sord-libs | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache soxr=0.1.3-r7; \
    apk info -qL soxr | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache speexdsp=1.2.1-r2; \
    apk info -qL speexdsp | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache spirv-tools=1.4.321.0-r1; \
    apk info -qL spirv-tools | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache sratom=0.6.18-r0; \
    apk info -qL sratom | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache tdb-libs=1.4.14-r0; \
    apk info -qL tdb-libs | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache tiff=4.7.1-r0; \
    apk info -qL tiff | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache v4l-utils-libs=1.32.0-r0; \
    apk info -qL v4l-utils-libs | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache vidstab=1.1.1-r0; \
    apk info -qL vidstab | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache vips=8.17.3-r1; \
    apk info -qL vips | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache vips-cpp=8.17.3-r1; \
    apk info -qL vips-cpp | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache vulkan-loader=1.4.321.0-r0; \
    apk info -qL vulkan-loader | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache wayland-libs-client=1.24.0-r0; \
    apk info -qL wayland-libs-client | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache x264-libs=0.164.3108-r1; \
    apk info -qL x264-libs | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache x265-libs=4.1-r0; \
    apk info -qL x265-libs | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache xvidcore=1.3.7-r2; \
    apk info -qL xvidcore | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache xz-libs=5.8.1-r0; \
    apk info -qL xz-libs | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache zimg=3.0.6-r0; \
    apk info -qL zimg | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache zix-libs=0.6.2-r0; \
    apk info -qL zix-libs | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache zlib=1.3.1-r2; \
    apk info -qL zlib | rsync -aq --files-from=- / /rootfs/; \
    apk add --no-cache zstd-libs=1.5.7-r2; \
    apk info -qL zstd-libs | rsync -aq --files-from=- / /rootfs/;

# Create data directories
RUN apk add --no-cache --virtual .create-directories-deps \
    busybox=1.37.0-r30 \
    musl=1.2.5-r21 \
    ;

# Create directories
RUN mkdir -p /rootfs/usr/src/app/upload /rootfs/usr/src/app/.reverse-geocoding-dump; \
    chown 65532:65532 /rootfs/usr/src/app/upload; \
    chown 65532:65532 /rootfs/usr/src/app/.reverse-geocoding-dump
RUN apk del --no-network .create-directories-deps

# Copy immich-server to rootfs
COPY --from=builder --chown=65532:65532 /app/server-deploy /rootfs/usr/src/app

# Copy geodata to rootfs
COPY --from=geodata /build/geodata /rootfs/build/geodata

# Copy plugin dist to rootfs
COPY --from=plugins /app/immich/plugins/dist /rootfs/build/corePlugin/dist

# Copy plugin manifest to rootfs
COPY --from=plugins /app/immich/plugins/manifest.json /rootfs/build/corePlugin/manifest.json


FROM reg.g5d.dev/node@sha256:a85e7e8102b80224985b68c759f945465dcf06b87118cd71589fbe9bf7ee5dfa

ENV NODE_ENV="production"

WORKDIR /usr/src/app

# Copy rootfs to root
COPY --from=rootfs /rootfs/ /

ENTRYPOINT ["node"]

CMD ["dist/main"]


